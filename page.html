<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>canvg.js callback test</title>
    <script type="text/javascript">
        require('canvg');
    </script>
    <script type="text/javascript">
        require('cheerio');
    </script>
    <script type="text/javascript" src="potrace.js"></script>
    <script type="text/javascript">
        var ipcRenderer = require('electron').ipcRenderer;
        ipcRenderer.on('potrace', function (event, path) {
            function fixsvgCode(code){
                var cheerio = require('cheerio');
                var $ = cheerio.load(code, {xmlMode: true});
                $('svg').find('[fill-rule="evenodd"]').removeAttr('fill-rule');
                return $.xml().toString();
            }
            var svg;
            Potrace.loadFromFS(path);
            console.log(Potrace);
            Potrace.process(function(){
                svg = Potrace.getSVG(512, null);
                svg = fixsvgCode(svg);
                ipcRenderer.send('potrace', svg);
            });
        });
        ipcRenderer.on('svg', function (event, code, width, height, format) {
            if(typeof(format) === "undefined"){
                format = 'image/png';
            }
            var canvas = document.getElementById('canvas');
            if(width){
                canvas.width = width;
                canvas.height = height;
                canvg('canvas', code, {ignoreDimensions: true, scaleWidth: width, scaleHeight: height});
            }else{
                canvg('canvas', code);
            }
            ipcRenderer.send('svg', canvas.toDataURL(format));
        });
    </script>
</head>
<body>
<div id="container"><canvas id="canvas"></canvas></div>
</body>
</html>
